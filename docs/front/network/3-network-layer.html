<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <meta name="author" content="swlws"><meta name="description" content="计算机网络-网络层概述"><meta name="keywords" content="网络层 IP层 ARP ICMP 网段 子网 网段划分 子网划分 IP数据报 路由 IPv6 NAT"><link rel="icon" href="/imgs/logo.png"><title>网络层 | Code思维</title>
    <link rel="modulepreload" href="/assets/app.28a1ca3c.js"><link rel="modulepreload" href="/assets/3-network-layer.html.830db719.js"><link rel="modulepreload" href="/assets/3-network-layer.html.93867eab.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/assets/style.173d2c01.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/imgs/logo.png" alt="Code思维"><span class="site-name can-hide">Code思维</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/front/" class="router-link-active" aria-label="前端"><!--[--><!--]--> 前端 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/secure/" class="" aria-label="安全"><!--[--><!--]--> 安全 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/tool/" class="" aria-label="工具"><!--[--><!--]--> 工具 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/swlws" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/front/" class="router-link-active" aria-label="前端"><!--[--><!--]--> 前端 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/secure/" class="" aria-label="安全"><!--[--><!--]--> 安全 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/tool/" class="" aria-label="工具"><!--[--><!--]--> 工具 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/swlws" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">TS <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/front/ts/code.html" class="sidebar-item" aria-label="代码片段"><!--[--><!--]--> 代码片段 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">通信 <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/front/tab-message.html" class="sidebar-item" aria-label="Web 间通信"><!--[--><!--]--> Web 间通信 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">HTML 5 <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/front/html5/reliable-request.html" class="sidebar-item" aria-label="页面关闭前，如何发送一个可靠请求"><!--[--><!--]--> 页面关闭前，如何发送一个可靠请求 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">Vue 3 <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/front/vue3/00-concept.html" class="sidebar-item" aria-label="Vue 3 Api 清单"><!--[--><!--]--> Vue 3 Api 清单 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/front/network/" class="router-link-active sidebar-item sidebar-heading active collapsible" aria-label="计算机网路"><!--[--><!--]--> 计算机网路 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/front/network/concept.html" class="sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a href="/front/network/2-link-layer.html" class="sidebar-item" aria-label="数据链路层"><!--[--><!--]--> 数据链路层 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="网络层"><!--[--><!--]--> 网络层 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/front/network/3-network-layer.html#网络层的两种服务" class="router-link-active router-link-exact-active sidebar-item" aria-label="网络层的两种服务"><!--[--><!--]--> 网络层的两种服务 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#网际协议-ip-internet-protocol" class="router-link-active router-link-exact-active sidebar-item" aria-label="网际协议 IP（Internet Protocol）"><!--[--><!--]--> 网际协议 IP（Internet Protocol） <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/front/network/3-network-layer.html#ip-地址和硬件地址" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 地址和硬件地址"><!--[--><!--]--> IP 地址和硬件地址 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#分类的-ip-地址" class="router-link-active router-link-exact-active sidebar-item" aria-label="分类的 IP 地址"><!--[--><!--]--> 分类的 IP 地址 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#地址解析协议-arp" class="router-link-active router-link-exact-active sidebar-item" aria-label="地址解析协议 ARP"><!--[--><!--]--> 地址解析协议 ARP <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ip-数据报" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 数据报"><!--[--><!--]--> IP 数据报 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ip-层转发分组流程-路由器转发分组" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 层转发分组流程（路由器转发分组）"><!--[--><!--]--> IP 层转发分组流程（路由器转发分组） <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/front/network/3-network-layer.html#子网划分和构造超网" class="router-link-active router-link-exact-active sidebar-item" aria-label="子网划分和构造超网"><!--[--><!--]--> 子网划分和构造超网 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#网际控制报文协议-icmp" class="router-link-active router-link-exact-active sidebar-item" aria-label="网际控制报文协议 ICMP"><!--[--><!--]--> 网际控制报文协议 ICMP <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#互联网的路由选择协议" class="router-link-active router-link-exact-active sidebar-item" aria-label="互联网的路由选择协议"><!--[--><!--]--> 互联网的路由选择协议 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/front/network/3-network-layer.html#理想的路由选择算法" class="router-link-active router-link-exact-active sidebar-item" aria-label="理想的路由选择算法"><!--[--><!--]--> 理想的路由选择算法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#分层次的路由选择协议" class="router-link-active router-link-exact-active sidebar-item" aria-label="分层次的路由选择协议"><!--[--><!--]--> 分层次的路由选择协议 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#路由器的构成" class="router-link-active router-link-exact-active sidebar-item" aria-label="路由器的构成"><!--[--><!--]--> 路由器的构成 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ipv6" class="router-link-active router-link-exact-active sidebar-item" aria-label="IPv6"><!--[--><!--]--> IPv6 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/front/network/3-network-layer.html#ipv6-的地址" class="router-link-active router-link-exact-active sidebar-item" aria-label="IPv6 的地址"><!--[--><!--]--> IPv6 的地址 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ipv6-数据报" class="router-link-active router-link-exact-active sidebar-item" aria-label="IPv6 数据报"><!--[--><!--]--> IPv6 数据报 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ipv4-向-ipv6-过渡" class="router-link-active router-link-exact-active sidebar-item" aria-label="IPv4 向 IPv6 过渡"><!--[--><!--]--> IPv4 向 IPv6 过渡 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#icmpv6" class="router-link-active router-link-exact-active sidebar-item" aria-label="ICMPv6"><!--[--><!--]--> ICMPv6 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ip-多播" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 多播"><!--[--><!--]--> IP 多播 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/front/network/3-network-layer.html#ip-多播实现需要的协议" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 多播实现需要的协议"><!--[--><!--]--> IP 多播实现需要的协议 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/front/network/3-network-layer.html#虚拟专用网-vpn-和网络地址转换-nat" class="router-link-active router-link-exact-active sidebar-item" aria-label="虚拟专用网 VPN 和网络地址转换 NAT"><!--[--><!--]--> 虚拟专用网 VPN 和网络地址转换 NAT <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/front/network/3-network-layer.html#虚拟专用网-vpn" class="router-link-active router-link-exact-active sidebar-item" aria-label="虚拟专用网 VPN"><!--[--><!--]--> 虚拟专用网 VPN <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#网络地址转换-nat" class="router-link-active router-link-exact-active sidebar-item" aria-label="网络地址转换 NAT"><!--[--><!--]--> 网络地址转换 NAT <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a href="/front/network/4-transport-layer.html" class="sidebar-item" aria-label="运输层"><!--[--><!--]--> 运输层 <!--[--><!--]--></a><!----></li><li><a href="/front/network/5-application-layer.html" class="sidebar-item" aria-label="应用层"><!--[--><!--]--> 应用层 <!--[--><!--]--></a><!----></li><li><a href="/front/network/6-secure.html" class="sidebar-item" aria-label="网络安全"><!--[--><!--]--> 网络安全 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">项目管理 <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/front/project/demand.html" class="sidebar-item" aria-label="需求（Demand）在哪里"><!--[--><!--]--> 需求（Demand）在哪里 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><hr><hr><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg2OTc0MzIxOA==&amp;mid=2247483668&amp;idx=1&amp;sn=0d26071c34efc912c8ffd27351be5ea3&amp;chksm=ce992e09f9eea71fc4d83f10fd3f5bae2ac8085d1d3d02e411b95a0e598f25d8ef3b76990f31&amp;token=923323399&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">首先发布在微信公众号<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><img src="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=102&amp;__biz=Mzg2OTc0MzIxOA==&amp;mid=2247483694&amp;idx=1&amp;sn=c2043de91c2f228153516fb715205599&amp;send_time="><br></p><hr><hr><h1 id="网络层" tabindex="-1"><a class="header-anchor" href="#网络层" aria-hidden="true">#</a> 网络层</h1><h2 id="网络层的两种服务" tabindex="-1"><a class="header-anchor" href="#网络层的两种服务" aria-hidden="true">#</a> 网络层的两种服务</h2><ul><li>虚电路服务。面向连接、可靠的服务。</li><li>数据报服务。无连接、最大努力交付的服务。</li></ul><p>TCP/IP 体系中，网络层向上层（运输层）只提供简单灵活的、无连接的、尽最大努力交付的数据报（IP 数据报）服务。网络层不提供服务质量的承诺。</p><h2 id="网际协议-ip-internet-protocol" tabindex="-1"><a class="header-anchor" href="#网际协议-ip-internet-protocol" aria-hidden="true">#</a> 网际协议 IP（Internet Protocol）</h2><p>这里的 IP 协议，指的是 TCP/IP 体系中的 IPv4 协议。</p><p>与 IP 协议配套的协议：</p><ul><li>地址解析协议 ARP（Address Resolution Protocol）</li><li>网际报文控制协议 ICMP（Internet Control Message Protocol）</li><li>网际组管理协议 IGMP（Internet Group Management Protocol）</li></ul><p>没有一种单一的网络能适应所有用户的需求（有各种各样的网络），将网络互相连接起来需要一些中间设备：</p><ul><li>物理层，使用的中间设备为<code>转发器</code></li><li>数据链路层，使用的中间设备为<code>网桥</code>或<code>桥接器</code></li><li>网络层，使用的中间设备为<code>路由器</code></li><li>网络层以上，使用的中间设备为<code>网关</code></li></ul><h3 id="ip-地址和硬件地址" tabindex="-1"><a class="header-anchor" href="#ip-地址和硬件地址" aria-hidden="true">#</a> IP 地址和硬件地址</h3><p><code>IP 地址</code></p><ul><li>即网络地址，主机在网络上的唯一标识。是网络层和以上各层使用的地址，是一种逻辑地址。</li><li>长度 32 位</li></ul><p><code>硬件地址（或物理地址、或MAC地址）</code></p><ul><li>是数据链路层和物理层使用的地址。</li><li>长度 48 位</li></ul><blockquote><p>局域网中，硬件地址已经固化在网卡的 ROM 中。</p></blockquote><h3 id="分类的-ip-地址" tabindex="-1"><a class="header-anchor" href="#分类的-ip-地址" aria-hidden="true">#</a> 分类的 IP 地址</h3><p><code>分类的 IP 地址</code>将 IP 地址固定的划分为若干类，每一类由<code>网络号(net-id)</code>和<code>主机号(host-id)</code>组成，格式：</p><blockquote><p>IP 地址 ::= {&lt;网络号&gt;, &lt;主机号&gt;}</p></blockquote><p>分类：</p><ul><li>A 类地址，{8, 24}，网络号的第一位为<code>0</code></li><li>B 类地址，{16, 16}，网络号的前两位为<code>10</code>，最小地址<code>128.1.0.0</code></li><li>C 类地址，{24, 8}，网络号的前三位为<code>110</code>，最小地址<code>192.0.1.0</code></li><li>D 类地址，前四位<code>1110</code>，用于多播（一对多通信）</li><li>E 类地址，前四位<code>1111</code>，保留为以后用</li></ul><p>两个特殊 IP 地址：</p><ul><li><code>0.0.0.0</code>表示本网络。</li><li><code>127.0.0.1</code>保留作为本地软件<code>回环测试（lookback test）</code>本主机进程之间的通信之用。</li></ul><p>路由器的特性：</p><ul><li>路由器至少连接两个网络，至少具备两个不同的网络号。</li><li>路由器只根据目的站的 IP 地址的网络号进行路由转发。</li></ul><h3 id="地址解析协议-arp" tabindex="-1"><a class="header-anchor" href="#地址解析协议-arp" aria-hidden="true">#</a> 地址解析协议 ARP</h3><p>将<code>IP地址</code>解析为<code>硬件地址</code>（备注：只能解析同网络的 IP 地址）.</p><p>每台主机都有一个<code>ARP高速缓存（ARP cache）</code>，里面有本局域网上各种主机和路由器的<code>IP地址</code>到<code>硬件地址</code>的映射，每条记录都有<code>生存时间</code>(如：10-20 分钟)</p><blockquote><p>linux 环境下，数据存储在/proc/net/arp，执行命令行 arp 也可查看数据</p></blockquote><p>拼接 MAC 帧时，MAC 地址的查找规则：</p><ul><li>找到 MAC 地址，直接写入</li><li>未找到 MAC 地址 <ul><li>ARP 进程在局域网网中，发送广播查找 <ul><li>找到目的主机的 MAC 地址</li><li>找到路由器的 MAC 地址</li></ul></li></ul></li></ul><p>Question：既然链路层上传送的帧最终是按照<code>硬件地址</code>找到目标主机，为何要使用抽象的 IP 地址，不直接使用<code>硬件地址</code>进行通信？</p><ol><li>各种各样的网络，使用不同的硬件地址。</li><li>异构的网络能够互相通信，必须进行<code>非常复杂硬件地址转换工作</code>，由用户、用户主机完成这个工作几乎是不可能的事情。</li><li>主机拥有一个唯一的 IP 地址，他们之间的通信就像连接在同一个网络上那么简单。</li></ol><h3 id="ip-数据报" tabindex="-1"><a class="header-anchor" href="#ip-数据报" aria-hidden="true">#</a> IP 数据报</h3><p>格式：{固定 20 个字节的首部} {可变长度的可选字段} {数据部分}</p><p>备注：数据报中总长度字段，占 16 位，单位为字节，因此 IP 数据报的最大长度为 2^16 -1 = 65535 个字节</p><h3 id="ip-层转发分组流程-路由器转发分组" tabindex="-1"><a class="header-anchor" href="#ip-层转发分组流程-路由器转发分组" aria-hidden="true">#</a> IP 层转发分组流程（路由器转发分组）</h3><p>路由表中每条路由记录最主要的信息：&lt;目的网络地址, 下一跳地址&gt;</p><p><code>路由表</code>中三种<code>路由记录</code>:</p><ul><li><code>基于目的主机所在网络的交付</code><ol><li>IP 数据报，最终一定能找到目的主机所在的目的网络上的路由器（可能要通过多次间接交付）。</li><li>只有到达最后一个路由器，才试图向目的主机进行直接交付。</li></ol></li><li><code>特定主机路由</code></li><li><code>默认路由</code></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># host ip为192.168.5.12的路由表</span>

<span class="token punctuation">[</span>root@localhost<span class="token punctuation">]</span><span class="token comment"># route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">192.168</span>.5.1     <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">192.168</span>.5.0     <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">192.168</span>.6.0     <span class="token number">192.168</span>.5.2     <span class="token number">255.255</span>.255.0   UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> ens33
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>路由表解释：</p><ul><li>第一条记录为<code>默认路由</code>，下一跳地址为<code>192.168.5.1</code></li><li>第二条记录为本网络的直接交付</li><li>第三条记录为，到<code>192.168.6.0</code>网络的下一跳地址为<code>192.168.5.2</code></li><li>Flags 中的 <ul><li><code>U</code>表示<code>路由是可用的</code></li><li><code>G</code>表示下一跳为<code>路由器</code>；<code>G存在</code>为<code>间接交付</code>，<code>G不存在</code>为<code>直接交付</code></li><li><code>H</code>表示该路由是到一台<code>主机</code>，若<code>不设置H</code>，则表示该路由是一个<code>网络</code></li></ul></li></ul><p>分组转发算法，路由优先级：</p><ul><li>与路由器直连的网络，直接交付</li><li>路由表中特定主机路由，执行下一跳</li><li>路由表中的网络路由，执行下一跳</li><li>路由表中的默认路由，执行下一跳</li><li>报告分组转发失败</li></ul><h2 id="子网划分和构造超网" tabindex="-1"><a class="header-anchor" href="#子网划分和构造超网" aria-hidden="true">#</a> 子网划分和构造超网</h2><p><code>两级 IP 地址</code> ::= { &lt;网络号&gt;, &lt;主机号&gt; }</p><p><code>三级 IP 地址</code> ::= { &lt;网络号&gt;, &lt;子网号&gt;, &lt;主机号&gt; }</p><p><code>子网的网络地址</code> := &lt;IP 地址&gt; AND &lt;子网掩码&gt;</p><p><code>无分类编址CIDR（构造超网）</code> ::= { &lt;网络前缀&gt;, &lt;主机号&gt; }</p><p>无分类域间路由选择 CIDR（Classless Inter-Domain Routing）：</p><ul><li>CIDR 消除了传统的 A 类、B 类、C 类地址以及划分子网的概念</li><li>CIDR 把<code>网络前缀</code>都相同的连续的 IP 地址组成一个<code>CIDR地址块</code></li></ul><blockquote><p>超网：一段连续的 IP 地址段，相当于其中可以包含多个 B 类、C 类地址</p></blockquote><p>超网<code>128.14.35.7/20</code>，语意：</p><ul><li>最小地址为，128.14.32.0</li><li>最大地址为，128.14.27.255</li></ul><h2 id="网际控制报文协议-icmp" tabindex="-1"><a class="header-anchor" href="#网际控制报文协议-icmp" aria-hidden="true">#</a> 网际控制报文协议 ICMP</h2><p>为了更有效的转发 IP 数据报和提高交付成功的机会，在网际层使用 ICMP（Internet Control Message Protocol）协议。它不是高层协议，而是 IP 层（网络层）的协议。</p><p>ICMP 报文种类：</p><ul><li>ICMP 差错报告报文</li><li>ICMP 询问报文。有两种： <ul><li>回送请求和回答</li><li>时间戳请求和回答</li></ul></li></ul><p>ICMP 的应用举例：</p><ul><li>ping <ul><li>使用的是<code>回送请求和回答</code>，测试两台主机之间的<code>连通性</code></li><li>在应用层直接使用网络层 ICMP，它没有使用 TCP/UDP</li><li>有的主机为了防止恶意攻击就不理睬外界发送过来的<code>ICMP回送请求</code>报文，例如：windows 机器</li></ul></li><li>traceroute <ul><li>用于追踪一个分组从源点到终点的路径</li><li>从源主机向目的主机发送一连串的<code>IP 数据报</code>，数据报中封装的是无法交付的 UDP 用户数据报</li></ul></li></ul><h2 id="互联网的路由选择协议" tabindex="-1"><a class="header-anchor" href="#互联网的路由选择协议" aria-hidden="true">#</a> 互联网的路由选择协议</h2><h3 id="理想的路由选择算法" tabindex="-1"><a class="header-anchor" href="#理想的路由选择算法" aria-hidden="true">#</a> 理想的路由选择算法</h3><p><code>理想的路由选择算法</code>的特点：</p><ul><li>算法必须是正确的、完整的。</li><li>算法在计算上应简单。不使网络通信量增加太多的额外开销</li><li>算法能适应通信量和网络拓扑的变化，即自适应性、稳健性</li><li>算法应具有稳定性。应收敛于一个可接受的解，不应使得路由不停的变化</li><li>算法是公平的。所有用户优先级相同。</li><li>算法应是最佳的。相对于某一种特定要求下得出较为合理的选择</li></ul><h3 id="分层次的路由选择协议" tabindex="-1"><a class="header-anchor" href="#分层次的路由选择协议" aria-hidden="true">#</a> 分层次的路由选择协议</h3><p><code>分层次的路由选择协议</code>，将互联网划分为许多较小的 <code>自洽系统（autonomous system）</code>，一般标记为<code>AS</code>.</p><p>使用<code>分层次的路由选择算法</code>，可将互联网的路由选择协议划分为：</p><ul><li>内部网关协议 IGP（Interior Gateway Protocol），具体的协议如： <ul><li>路由信息协议 RIP（Routing Information Protocol）</li><li>开放最短路径优先 OSPF（Open Shortest Path First）</li></ul></li><li>外部网关协议 XGP（External Gateway Protocol），具体的协议： <ul><li>边界网关协议 BGP</li></ul></li></ul><h3 id="路由器的构成" tabindex="-1"><a class="header-anchor" href="#路由器的构成" aria-hidden="true">#</a> 路由器的构成</h3><p>路由器的任务：</p><ul><li>路由选择</li><li>转发分组</li></ul><p>路由器的结构：</p><ul><li>多个输入端口、多个输出端口</li></ul><p><code>路由表和转发表</code>对比:</p><blockquote><p>在讨论路由选择原理时，不区分转发表、路由表的区别，笼统的使用路由表一词</p></blockquote><table><thead><tr><th></th><th>路由表</th><th>转发表</th></tr></thead><tbody><tr><td>记录来源</td><td>是许多路由器协同工作得出的结果</td><td>从路由表得出</td></tr><tr><td>单行记录</td><td>目的网络到下一跳地址的映射</td><td>要到达的目的网络，到输出端口、MAC 地址信息的映射</td></tr><tr><td>分组转发时的优点</td><td>路由表是对网络拓扑变化的计算最优化</td><td>转发表的结构使查找过程最优化</td></tr><tr><td>实现方式</td><td>总是使用软件</td><td>软件、硬件都可以</td></tr></tbody></table><h2 id="ipv6" tabindex="-1"><a class="header-anchor" href="#ipv6" aria-hidden="true">#</a> IPv6</h2><h3 id="ipv6-的地址" tabindex="-1"><a class="header-anchor" href="#ipv6-的地址" aria-hidden="true">#</a> IPv6 的地址</h3><p>IPv6 地址长度：128 位</p><p>书写方式，采用<code>冒号十六进制记法</code>，eg：</p><blockquote><p>6836:8c64:0:0:0:0:2222:ffff</p></blockquote><p>书写规则：</p><ul><li>十六进制中，允许把数字前的 0 省略</li><li>允许<code>零压缩</code>,即多个相连的<code>0</code>，可以压缩为<code>6836:8c64::2222:ffff</code></li><li>允许结合使用<code>点分十进制</code>的后缀，如：<code>::128.0.0.1</code></li><li>无分类编址 CIDR（构造超网）的斜线表示法依然可用，如<code>12AB:0:0:CD30::/60</code></li></ul><p>一个 IPv6 数据报的目的地址可以是 yi 一下三种基本类型地址之一：</p><ul><li>单播地址。传统的点对点通信。</li><li>多播地址。一点对多点通信。</li><li>任播地址。IPv6 新增类型，任播的终点是一组计算机，但数据报只交付给其中一个，通常是距离最近的。</li></ul><h3 id="ipv6-数据报" tabindex="-1"><a class="header-anchor" href="#ipv6-数据报" aria-hidden="true">#</a> IPv6 数据报</h3><ul><li>基本首部（固定 40 个字节） + 有效载荷（最大 64KB）</li></ul><p>备注：数据报中有效载荷占 16 位，它表明除基本首部以外的字节数，最大为 64KB（即 65535 字节）</p><h3 id="ipv4-向-ipv6-过渡" tabindex="-1"><a class="header-anchor" href="#ipv4-向-ipv6-过渡" aria-hidden="true">#</a> IPv4 向 IPv6 过渡</h3><p>两种过渡策略：</p><ul><li>双协议栈（dual stack） <ul><li>同时支持 IPv4 和 IPv6 协议</li></ul></li><li>隧道技术（tunneling） <ul><li>IPv6 数据报进入 IPv4 网络时，把 IPv6 数据报封装成 IPv4 数据报</li></ul></li></ul><h3 id="icmpv6" tabindex="-1"><a class="header-anchor" href="#icmpv6" aria-hidden="true">#</a> ICMPv6</h3><p>与 IPv4 一样，不保证可靠交付。新版的 ICMPv6，将 ARP（地址解析协议） 和 IGMP（网际组管理协议） 合并到了 ICMPv6 中。</p><h2 id="ip-多播" tabindex="-1"><a class="header-anchor" href="#ip-多播" aria-hidden="true">#</a> IP 多播</h2><blockquote><p>TODO: 这块以后再细看（可能永远不看&lt;_&lt;）</p></blockquote><p>在互联网上进行多播就叫做<code>IP多播</code>.</p><p>IP 多播的目的地址，<code>D类IP地址</code>，即范围（D 类地址的千四位的前缀是 1110）为<code>224.0.0.0到239.255.255.255</code></p><p><code>多播路由器</code>，用于实现在互联网范围的多播，也可以转发普通的单播 IP 数据报。</p><p>IP 多播有两种：</p><ul><li>本局域网上进行硬件多播</li><li>互联网范围进行多播</li></ul><h3 id="ip-多播实现需要的协议" tabindex="-1"><a class="header-anchor" href="#ip-多播实现需要的协议" aria-hidden="true">#</a> IP 多播实现需要的协议</h3><p>需要的协议：</p><ul><li><code>网际组管理协议IGMP（Internet Group Manangement Protocol）</code>，让连接在<code>本地局域网</code>的多播路由器知道<code>本局域网</code>上是否有主机（严格讲，是主机上的进程）参加或退出多播组。</li><li><code>多播路由选择协议</code><ul><li>洪泛和翦除</li><li>隧道技术</li><li>基于核心的发现技术</li></ul></li></ul><h2 id="虚拟专用网-vpn-和网络地址转换-nat" tabindex="-1"><a class="header-anchor" href="#虚拟专用网-vpn-和网络地址转换-nat" aria-hidden="true">#</a> 虚拟专用网 VPN 和网络地址转换 NAT</h2><h3 id="虚拟专用网-vpn" tabindex="-1"><a class="header-anchor" href="#虚拟专用网-vpn" aria-hidden="true">#</a> 虚拟专用网 VPN</h3><p><code>专用地址</code>，只能用于一个机构内的通信，不能用于和互联网上的主机通信。即在互联网中的所有路由器，对<code>目的地址是专用地址</code>的数据报一律不进行转发。</p><p>专用网 IP 地址段</p><ul><li>A 类：10.0.0.0 到 10.255.255.255 （1658 万个）</li><li>B 类：172.16.0.0 到 172.31.255.255 （104 万个）</li><li>C 类：192.168.0.0 到 192.168.255.255 （6.5 万个）</li></ul><p>互联网 IP（全球合法 IP） 地址段：</p><ul><li>A 类： <ul><li>1.0.0.0----9.255.255.255 （1.5 亿个）</li><li>11.0.0.0-----126.255.255.255 （19.23 亿个）</li></ul></li><li>B 类： <ul><li>128.0.0.0-----172.15.255.255 （7.3 亿个）</li><li>172.32.0.0-----191.255.255.255 （3.3 亿个）</li></ul></li><li>C 类： <ul><li>192.0.0.0-------192.167.255.255 （0.11 亿个）</li><li>192.169.0.0-----223.255.255.255 （5.03 亿个）</li></ul></li></ul><p>VPN 的应用：</p><ol><li>专用网之间之间建立通信，特点：</li></ol><ul><li>与专用网连接的路由器具有<code>合法的全球IP</code></li></ul><ol start="2"><li>个人与专用网建立通信，特点：</li></ol><ul><li>员工通过拨号进入互联网</li><li>驻留在个人电脑中 VPN 软件，在个人电脑和公司主机之间建立 VPN 隧道</li></ul><h3 id="网络地址转换-nat" tabindex="-1"><a class="header-anchor" href="#网络地址转换-nat" aria-hidden="true">#</a> 网络地址转换 NAT</h3><p>解决的问题：专用网的主机，需要和互联网上的主机通信。</p><p>解决方案：在专用网连接到互联网的路由器上安装 NAT 软件，这种路由器称为<code>NAT路由器</code>，它至少有一个有效的外部全球 IP 地址。</p><p><code>NAT路由器</code>的作用：</p><ul><li>NAT 路由器的通信，必须由<code>专用网发起</code></li><li>将专用网中主机发送的 IP 数据报中的源 IP 地址，修改为 NAT 路由器的全球 IP 地址，然后转发出去。</li><li>将从互联网收到的 IP 数据报中的目标地址，通过 <code>NAT 地址转换表</code>，转化为专用网的目的主机的 IP 地址。</li></ul><p>备注：当 NAT 转换表，仅记录 IP 时，同一时间，仅能有一台专用网的主机，使用 NAT 路由器向互联网通信。当 NAT 转换表，记录&lt;ip, port&gt;时，同一时间，支持多个专用网主机向互联网通信。</p><p>传统 NAT（traditional NAT），使用 IP 的转换表示例：</p><table><thead><tr><th>方向</th><th>字段</th><th>旧的 IP 地址</th><th>新的 IP 地址</th></tr></thead><tbody><tr><td>出</td><td>源 IP 地址</td><td>192.168.0.3</td><td>172.38.1.5</td></tr><tr><td>入</td><td>目的 IP 地址</td><td>172.38.1.5</td><td>192.168.0.3</td></tr><tr><td>出</td><td>源 IP 地址</td><td>192.168.0.7</td><td>172.38.1.6</td></tr><tr><td>入</td><td>目的 IP 地址</td><td>172.38.1.6</td><td>192.168.0.7</td></tr></tbody></table><p>NAPT（Network Address And Port Translation）,使用 IP、端口的转换表示例：</p><table><thead><tr><th>方向</th><th>字段</th><th>旧的 IP 地址和端口号</th><th>新的 IP 地址和端口号</th></tr></thead><tbody><tr><td>出</td><td>源 IP 地址:TCP 源端口</td><td>192.168.0.3:3000</td><td>172.38.1.5:40001</td></tr><tr><td>出</td><td>源 IP 地址:TCP 源端口</td><td>192.168.0.4:3000</td><td>172.38.1.5:40002</td></tr><tr><td>入</td><td>目的 IP 地址:TCP 目的端口</td><td>172.38.1.5:40001</td><td>172.38.0.3:3000</td></tr><tr><td>入</td><td>目的 IP 地址:TCP 目的端口</td><td>172.38.1.5:40002</td><td>172.38.0.4:3000</td></tr></tbody></table><p>备注：路由器是工作在网络层的设备，NAPT 路由器，还要查看运输层的端口。</p><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/front/network/2-link-layer.html" class="" aria-label="数据链路层"><!--[--><!--]--> 数据链路层 <!--[--><!--]--></a></span><span class="next"><a href="/front/network/4-transport-layer.html" class="" aria-label="运输层"><!--[--><!--]--> 运输层 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.28a1ca3c.js" defer></script>
  </body>
</html>

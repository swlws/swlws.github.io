<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.32">
    <title>网络层 | CodeLife</title><meta name="description" content="JUST PLAY">
    <link rel="modulepreload" href="/assets/app.3445e116.js"><link rel="modulepreload" href="/assets/3-network-layer.html.ad0a879c.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/3-network-layer.html.f8d04fb2.js">
    <link rel="stylesheet" href="/assets/style.a0d6d5ca.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">CodeLife</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><a href="/front/" class="router-link-active" aria-label="Front"><!--[--><!--]--> Front <!--[--><!--]--></a></div><div class="navbar-item"><a href="/secure/" class="" aria-label="Secure"><!--[--><!--]--> Secure <!--[--><!--]--></a></div><div class="navbar-item"><a href="/tool/" class="" aria-label="Tool"><!--[--><!--]--> Tool <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/swlws" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><a href="/front/" class="router-link-active" aria-label="Front"><!--[--><!--]--> Front <!--[--><!--]--></a></div><div class="navbar-item"><a href="/secure/" class="" aria-label="Secure"><!--[--><!--]--> Secure <!--[--><!--]--></a></div><div class="navbar-item"><a href="/tool/" class="" aria-label="Tool"><!--[--><!--]--> Tool <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/swlws" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p class="sidebar-item sidebar-heading collapsible">TS <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/front/ts/code.html" class="sidebar-item" aria-label="代码片段"><!--[--><!--]--> 代码片段 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p class="sidebar-item sidebar-heading collapsible">通信 <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/front/tab-message.html" class="sidebar-item" aria-label="Web 间通信"><!--[--><!--]--> Web 间通信 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/front/network/" class="router-link-active sidebar-item sidebar-heading active collapsible" aria-label="计算机网路"><!--[--><!--]--> 计算机网路 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/front/network/concept.html" class="sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a href="/front/network/2-link-layer.html" class="sidebar-item" aria-label="数据链路层"><!--[--><!--]--> 数据链路层 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="网络层"><!--[--><!--]--> 网络层 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/front/network/3-network-layer.html#网络层的两种服务" class="router-link-active router-link-exact-active sidebar-item" aria-label="网络层的两种服务"><!--[--><!--]--> 网络层的两种服务 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#网际协议-ip-internet-protocol" class="router-link-active router-link-exact-active sidebar-item" aria-label="网际协议 IP（Internet Protocol）"><!--[--><!--]--> 网际协议 IP（Internet Protocol） <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/front/network/3-network-layer.html#ip-地址和硬件地址" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 地址和硬件地址"><!--[--><!--]--> IP 地址和硬件地址 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#分类的-ip-地址" class="router-link-active router-link-exact-active sidebar-item" aria-label="分类的 IP 地址"><!--[--><!--]--> 分类的 IP 地址 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#地址解析协议-arp" class="router-link-active router-link-exact-active sidebar-item" aria-label="地址解析协议 ARP"><!--[--><!--]--> 地址解析协议 ARP <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ip-数据报" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 数据报"><!--[--><!--]--> IP 数据报 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ip-层转发分组流程-路由器转发分组" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 层转发分组流程（路由器转发分组）"><!--[--><!--]--> IP 层转发分组流程（路由器转发分组） <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/front/network/3-network-layer.html#子网划分和构造超网" class="router-link-active router-link-exact-active sidebar-item" aria-label="子网划分和构造超网"><!--[--><!--]--> 子网划分和构造超网 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#网际控制报文协议-icmp" class="router-link-active router-link-exact-active sidebar-item" aria-label="网际控制报文协议 ICMP"><!--[--><!--]--> 网际控制报文协议 ICMP <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#互联网的路由选择协议" class="router-link-active router-link-exact-active sidebar-item" aria-label="互联网的路由选择协议"><!--[--><!--]--> 互联网的路由选择协议 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ipv6" class="router-link-active router-link-exact-active sidebar-item" aria-label="IPV6"><!--[--><!--]--> IPV6 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/front/network/3-network-layer.html#ip-多播" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 多播"><!--[--><!--]--> IP 多播 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="网络层" tabindex="-1"><a class="header-anchor" href="#网络层" aria-hidden="true">#</a> 网络层</h1><h2 id="网络层的两种服务" tabindex="-1"><a class="header-anchor" href="#网络层的两种服务" aria-hidden="true">#</a> 网络层的两种服务</h2><ul><li>虚电路服务。面向连接、可靠的服务。</li><li>数据报服务。无连接、最大努力交付的服务。</li></ul><p>TCP/IP 体系中，网络层向上层（运输层）只提供简单灵活的、无连接的、尽最大努力交付的数据报（IP 数据报）服务。网络层不提供服务质量的承诺。</p><h2 id="网际协议-ip-internet-protocol" tabindex="-1"><a class="header-anchor" href="#网际协议-ip-internet-protocol" aria-hidden="true">#</a> 网际协议 IP（Internet Protocol）</h2><p>这里的 IP 协议，指的是 TCP/IP 体系中的 IPv4 协议。</p><p>与 IP 协议配套的协议：</p><ul><li>地址解析协议 ARP（Address Resolution Protocol）</li><li>网际报文控制协议 ICMP（Internet Control Message Protocol）</li><li>网际组管理协议 IGMP（Internet Group Management Protocol）</li></ul><p>没有一种单一的网络能适应所有用户的需求（有各种各样的网络），将网络互相连接起来需要一些中间设备：</p><ul><li>物理层，使用的中间设备为<code>转发器</code></li><li>数据链路层，使用的中间设备为<code>网桥</code>或<code>桥接器</code></li><li>网络层，使用的中间设备为<code>路由器</code></li><li>网络层以上，使用的中间设备为<code>网关</code></li></ul><h3 id="ip-地址和硬件地址" tabindex="-1"><a class="header-anchor" href="#ip-地址和硬件地址" aria-hidden="true">#</a> IP 地址和硬件地址</h3><p><code>IP 地址</code></p><ul><li>即网络地址，主机在网络上的唯一标识。是网络层和以上各层是用的地址，是一种逻辑地址。</li><li>长度 32 位</li></ul><p><code>硬件地址（或物理地址、或MAC地址）</code></p><ul><li>是数据链路层和物理层是用的地址。</li><li>长度 48 位</li></ul><blockquote><p>局域网中，硬件地址已经固化在网卡的 ROM 中。</p></blockquote><h3 id="分类的-ip-地址" tabindex="-1"><a class="header-anchor" href="#分类的-ip-地址" aria-hidden="true">#</a> 分类的 IP 地址</h3><p><code>分类的 IP 地址</code>将 IP 地址固定的划分为若干类，每一类由<code>网络号(net-id)</code>和<code>主机号(host-id)</code>组成，格式：</p><blockquote><p>IP 地址 ::= {&lt;网络号&gt;, &lt;主机号&gt;}</p></blockquote><p>分类：</p><ul><li>A 类地址，{8, 24}，网络号的第一位为<code>0</code></li><li>B 类地址，{16, 16}，网络号的前两位为<code>10</code>，最小地址<code>128.1.0.0</code></li><li>C 类地址，{24, 8}，网络号的前三位为<code>110</code>，最小地址<code>192.0.1.0</code></li><li>D 类地址，前四位<code>1110</code>，用于多播（一对多通信）</li><li>E 类地址，前四位<code>1111</code>，保留位以后用</li></ul><p>两个特殊 IP 地址：</p><ul><li><code>0.0.0.0</code>表示本网络。</li><li><code>127.0.0.1</code>保留作为本地软件<code>回环测试（lookback test）</code>本主机进程之间的通信之用。</li></ul><p>路由器的特性：</p><ul><li>路由器至少连接两个网络，至少具备两个不同的网络号。</li><li>路由器只根据目的站的 IP 地址的网络号进行路由转发。</li></ul><h3 id="地址解析协议-arp" tabindex="-1"><a class="header-anchor" href="#地址解析协议-arp" aria-hidden="true">#</a> 地址解析协议 ARP</h3><p>将<code>IP地址</code>解析为<code>硬件地址</code>.</p><p>每台主机都有一个<code>ARP高速换粗（ARP cache）</code>，里面有本局域网上各种主机和路由器的<code>IP地址</code>到<code>硬件地址</code>的映射，每条记录都有<code>生存时间</code>(如：10-20 分钟)</p><blockquote><p>linux 环境下，数据存储在/proc/net/arp，执行命令行 arp 也可查看数据</p></blockquote><p>拼接 MAC 帧时，MAC 地址的查找规则：</p><ul><li>找到 MAC 地址，直接写入</li><li>未找到 MAC 地址 <ul><li>ARP 进程在局域网网中，发送广播查找 <ul><li>找到目的主机的 MAC 地址</li><li>找到路由器的 MAC 地址</li></ul></li></ul></li></ul><p>Question：既然链路层上传送的帧最终时按照<code>硬件地址</code>找到目标主机，为何要使用抽象的 IP 地址，不直接使用<code>硬件地址</code>进行通信？</p><ol><li>各种各样的网络，使用不同的硬件地址。</li><li>异构的网络能够互相通信，必须进行<code>非常复杂硬件地址转换工作</code>，由用户、用户主机完成这个工作几乎是不可能的事情。</li><li>主机拥有一个唯一的 IP 地址，他们之间的通信就像连接在同一个网络上那么简单。</li></ol><h3 id="ip-数据报" tabindex="-1"><a class="header-anchor" href="#ip-数据报" aria-hidden="true">#</a> IP 数据报</h3><p>格式：{固定 20 个字节的首部} {可变长度的可选字段} {数据部分}</p><p>备注：IP 数据报的最大长度为 2^16 -1 = 65535 个字节</p><h3 id="ip-层转发分组流程-路由器转发分组" tabindex="-1"><a class="header-anchor" href="#ip-层转发分组流程-路由器转发分组" aria-hidden="true">#</a> IP 层转发分组流程（路由器转发分组）</h3><p>路由表中每条路由记录最主要的信息：&lt;目的网络地址, 下一跳地址&gt;</p><p><code>路由表</code>中三种<code>路由记录</code>:</p><ul><li><code>基于目的主机所在网络的交付</code><ol><li>IP 数据报，最终一定能找到目的主机所在的目的网络上的路由器（可能要通过多次间接交付）。</li><li>只有到达最后一个路由器，才试图向目的主机进行直接交付。</li></ol></li><li><code>特定主机路由</code></li><li><code>默认路由</code></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># host ip为192.168.5.12的路由表</span>

<span class="token punctuation">[</span>root@localhost<span class="token punctuation">]</span><span class="token comment"># route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">192.168</span>.5.1     <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">192.168</span>.5.0     <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> ens33
<span class="token number">192.168</span>.6.0     <span class="token number">192.168</span>.5.2     <span class="token number">255.255</span>.255.0   UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> ens33
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>路由表解释：</p><ul><li>第一条记录为<code>默认路由</code>，下一跳地址为<code>192.168.5.1</code></li><li>第二条记录为本网络的直接交付</li><li>第二条记录为，到<code>192.168.6.0</code>网络的下一跳地址为<code>192.168.5.2</code></li><li>Flags 中的 <ul><li><code>U</code>表示<code>路由是可用的</code></li><li><code>G</code>表示下一跳为<code>路由器</code>；<code>G存在</code>为<code>间接交付</code>，<code>G不存在</code>为<code>直接交付</code></li><li><code>H</code>表示该路由是到一台<code>主机</code>，若<code>不设置H</code>，则表示该路由是一个<code>网络</code></li></ul></li></ul><p>分组转发算法，路有优先级：</p><ul><li>与路由器直连的网络，直接交付</li><li>路由表中特定主机路由，执行下一跳</li><li>路由表中的网络路由，执行下一跳</li><li>路由表中的默认路由，执行下一跳</li><li>报告分组转发失败</li></ul><h2 id="子网划分和构造超网" tabindex="-1"><a class="header-anchor" href="#子网划分和构造超网" aria-hidden="true">#</a> 子网划分和构造超网</h2><p><code>两级 IP 地址</code> := { &lt;网络号&gt;, &lt;主机号&gt; } <code>三级 IP 地址</code> := { &lt;网络号&gt;, &lt;子网号&gt;, &lt;主机号&gt; }</p><p><code>子网的网络地址</code>：&lt;IP 地址&gt; AND &lt;子网掩码&gt;</p><h2 id="网际控制报文协议-icmp" tabindex="-1"><a class="header-anchor" href="#网际控制报文协议-icmp" aria-hidden="true">#</a> 网际控制报文协议 ICMP</h2><h2 id="互联网的路由选择协议" tabindex="-1"><a class="header-anchor" href="#互联网的路由选择协议" aria-hidden="true">#</a> 互联网的路由选择协议</h2><h2 id="ipv6" tabindex="-1"><a class="header-anchor" href="#ipv6" aria-hidden="true">#</a> IPV6</h2><h2 id="ip-多播" tabindex="-1"><a class="header-anchor" href="#ip-多播" aria-hidden="true">#</a> IP 多播</h2><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/front/network/2-link-layer.html" class="" aria-label="数据链路层"><!--[--><!--]--> 数据链路层 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.3445e116.js" defer></script>
  </body>
</html>

---
editLink: false
head:
  - - meta
    - name: author
      content: swlws
  - - meta
    - name: description
      content: 计算机网络-网络层概述
  - - meta
    - name: keywords
      content: 网络层 IP层 ARP ICMP 网段 子网 网段划分 子网划分 IP数据报 路由 IPv6 NAT
---

# 网络层

## 网络层的两种服务

- 虚电路服务。面向连接、可靠的服务。
- 数据报服务。无连接、最大努力交付的服务。

TCP/IP 体系中，网络层向上层（运输层）只提供简单灵活的、无连接的、尽最大努力交付的数据报（IP 数据报）服务。网络层不提供服务质量的承诺。

## 网际协议 IP（Internet Protocol）

这里的 IP 协议，指的是 TCP/IP 体系中的 IPv4 协议。

与 IP 协议配套的协议：

- 地址解析协议 ARP（Address Resolution Protocol）
- 网际报文控制协议 ICMP（Internet Control Message Protocol）
- 网际组管理协议 IGMP（Internet Group Management Protocol）

没有一种单一的网络能适应所有用户的需求（有各种各样的网络），将网络互相连接起来需要一些中间设备：

- 物理层，使用的中间设备为`转发器`
- 数据链路层，使用的中间设备为`网桥`或`桥接器`
- 网络层，使用的中间设备为`路由器`
- 网络层以上，使用的中间设备为`网关`

### IP 地址和硬件地址

`IP 地址`

- 即网络地址，主机在网络上的唯一标识。是网络层和以上各层是用的地址，是一种逻辑地址。
- 长度 32 位

`硬件地址（或物理地址、或MAC地址）`

- 是数据链路层和物理层是用的地址。
- 长度 48 位

> 局域网中，硬件地址已经固化在网卡的 ROM 中。

### 分类的 IP 地址

`分类的 IP 地址`将 IP 地址固定的划分为若干类，每一类由`网络号(net-id)`和`主机号(host-id)`组成，格式：

> IP 地址 ::= {<网络号>, <主机号>}

分类：

- A 类地址，{8, 24}，网络号的第一位为`0`
- B 类地址，{16, 16}，网络号的前两位为`10`，最小地址`128.1.0.0`
- C 类地址，{24, 8}，网络号的前三位为`110`，最小地址`192.0.1.0`
- D 类地址，前四位`1110`，用于多播（一对多通信）
- E 类地址，前四位`1111`，保留位以后用

两个特殊 IP 地址：

- `0.0.0.0`表示本网络。
- `127.0.0.1`保留作为本地软件`回环测试（lookback test）`本主机进程之间的通信之用。

路由器的特性：

- 路由器至少连接两个网络，至少具备两个不同的网络号。
- 路由器只根据目的站的 IP 地址的网络号进行路由转发。

### 地址解析协议 ARP

将`IP地址`解析为`硬件地址`（备注：只能解析同网络的 IP 地址）.

每台主机都有一个`ARP高速换粗（ARP cache）`，里面有本局域网上各种主机和路由器的`IP地址`到`硬件地址`的映射，每条记录都有`生存时间`(如：10-20 分钟)

> linux 环境下，数据存储在/proc/net/arp，执行命令行 arp 也可查看数据

拼接 MAC 帧时，MAC 地址的查找规则：

- 找到 MAC 地址，直接写入
- 未找到 MAC 地址
  - ARP 进程在局域网网中，发送广播查找
    - 找到目的主机的 MAC 地址
    - 找到路由器的 MAC 地址

Question：既然链路层上传送的帧最终时按照`硬件地址`找到目标主机，为何要使用抽象的 IP 地址，不直接使用`硬件地址`进行通信？

1. 各种各样的网络，使用不同的硬件地址。
2. 异构的网络能够互相通信，必须进行`非常复杂硬件地址转换工作`，由用户、用户主机完成这个工作几乎是不可能的事情。
3. 主机拥有一个唯一的 IP 地址，他们之间的通信就像连接在同一个网络上那么简单。

### IP 数据报

格式：{固定 20 个字节的首部} {可变长度的可选字段} {数据部分}

备注：数据报中总长度字段，占 16 位，单位为字节，因此 IP 数据报的最大长度为 2^16 -1 = 65535 个字节

### IP 层转发分组流程（路由器转发分组）

路由表中每条路由记录最主要的信息：<目的网络地址, 下一跳地址>

`路由表`中三种`路由记录`:

- `基于目的主机所在网络的交付`
  1. IP 数据报，最终一定能找到目的主机所在的目的网络上的路由器（可能要通过多次间接交付）。
  2. 只有到达最后一个路由器，才试图向目的主机进行直接交付。
- `特定主机路由`
- `默认路由`

```bash
# host ip为192.168.5.12的路由表

[root@localhost]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.5.1     0.0.0.0         UG    100    0        0 ens33
192.168.5.0     0.0.0.0         255.255.255.0   U     100    0        0 ens33
192.168.6.0     192.168.5.2     255.255.255.0   UG    0      0        0 ens33
```

路由表解释：

- 第一条记录为`默认路由`，下一跳地址为`192.168.5.1`
- 第二条记录为本网络的直接交付
- 第二条记录为，到`192.168.6.0`网络的下一跳地址为`192.168.5.2`
- Flags 中的
  - `U`表示`路由是可用的`
  - `G`表示下一跳为`路由器`；`G存在`为`间接交付`，`G不存在`为`直接交付`
  - `H`表示该路由是到一台`主机`，若`不设置H`，则表示该路由是一个`网络`

分组转发算法，路有优先级：

- 与路由器直连的网络，直接交付
- 路由表中特定主机路由，执行下一跳
- 路由表中的网络路由，执行下一跳
- 路由表中的默认路由，执行下一跳
- 报告分组转发失败

## 子网划分和构造超网

`两级 IP 地址` ::= { <网络号>, <主机号> }

`三级 IP 地址` ::= { <网络号>, <子网号>, <主机号> }

`子网的网络地址` := <IP 地址> AND <子网掩码>

`无分类编址CIDR（构造超网）` ::= { <网络前缀>, <主机号> }

无分类域间路由选择 CIDR（Classless Inter-Domain Routing）：

- CIDR 消除了传统的 A 类、B 类、C 类地址以及划分子网的概念
- CIDR 把`网络前缀`都相同的连续的 IP 地址组成一个`CIDR地址块`

> 超网：一段连续的 IP 地址段，相当于其中可以包含多个 B 类、C 类地址

超网`128.14.35.7/20`，语意：

- 最小地址为，128.14.32.0
- 最大地址为，128.14.27.255

## 网际控制报文协议 ICMP

为了更有效的转发 IP 数据报和提高交付成功的机会，在网际层使用 ICMP（Internet Control Message Protocol）协议。它不是高层协议，而是 IP 层（网络层）的协议。

ICMP 报文种类：

- ICMP 差错报告报文
- ICMP 询问报文。有两种：
  - 回送请求和回答
  - 时间戳请求和回答

ICMP 的应用举例：

- ping
  - 使用的是`回送请求和回答`，测试两台主机之间的`连通性`
  - 在应用层直接使用网络层 ICMP，它没有使用 TCP/UDP
  - 有的主机为了防止恶意攻击就不理睬外界发送过来的`ICMP回送请求`报文，例如：windows 机器
- traceroute
  - 用于追踪一个分组从源点到终点的路径
  - 从源主机向目的主机发送一连串的`IP 数据报`，数据报中封装的是无法交付的 UDP 用户数据报

## 互联网的路由选择协议

### 理想的路由选择算法

`理想的路由选择算法`的特点：

- 算法必须是正确的、完整的。
- 算法在计算上应简单。不使网络通信量增加太多的额外开销
- 算法能适应通信量和网络拓扑的变化，即自适应性、稳健性
- 算法应具有稳定性。应收敛于一个可接受的解，不应使得路由不停的变化
- 算法是公平的。所有用户优先级相同。
- 算法应是最佳的。相对于某一种特定要求下得出较为合理的选择

### 分层次的路由选择协议

`分层次的路由选择协议`，将互联网划分为许多较小的 `自洽系统（autonomous system）`，一般标记为`AS`.

使用`分层次的路由选择算法`，可将互联网的路由选择协议划分为：

- 内部网关协议 IGP（Interior Gateway Protocol），具体的协议如：
  - 路由信息协议 RIP（Routing Information Protocol）
  - 开放最短路径优先 OSPF（Open Shortest Path First）
- 外部网关协议 XGP（External Gateway Protocol），具体的协议：
  - 边界网关协议 BGP

### 路由器的构成

路由器的任务：

- 路由选择
- 转发分组

路由器的结构：

- 多个输入端口、多个输出端口

`路由表和转发表`对比:

> 在讨论路由选择原理时，不区分转发表、路由表的区别，笼统的使用路由表一词

|                  | 路由表                             | 转发表                                           |
| ---------------- | ---------------------------------- | ------------------------------------------------ |
| 记录来源         | 是许多路由器协同工作得出的结果     | 从路由表得出                                     |
| 单行记录         | 目的网络到下一跳地址的映射         | 要到达的目的网络，到输出端口、MAC 地址信息的映射 |
| 分组转发时的优点 | 路由表时对网络拓扑变化的计算最优化 | 转发表的结构使查找过程最优化                     |
| 实现方式         | 总是使用软件                       | 软件、硬件都可以                                 |

## IPv6

### IPv6 的地址

IPv6 地址长度：128 位

书写方式，采用`冒号十六进制记法`，eg：

> 6836:8c64:0:0:0:0:2222:ffff

书写规则：

- 十六进制中，允许把数字前的 0 省略
- 允许`零压缩`,即多个相连的`0`，可以压缩为`6836:8c64::2222:ffff`
- 允许结合使用`点分十进制`的后缀，如：`::128.0.0.1`
- 无分类编址 CIDR（构造超网）的斜线表示法依然可用，如`12AB:0:0:CD30::/60`

一个 IPv6 数据报的目的地址可以是 yi 一下三种基本类型地址之一：

- 单播地址。传统的点对点通信。
- 多播地址。一点对多点通信。
- 任播地址。IPv6 新增类型，任播的终点是一组计算机，但数据报只交付给其中一个，通常是距离最近的。

### IPv6 数据报

- 基本首部（固定 40 个字节） + 有效载荷（最大 64KB）

备注：数据报中有效载荷占 16 位，它表明除基本首部以外的字节数，最大为 64KB（即 65535 字节）

### IPv4 向 IPv6 过渡

两种过渡策略：

- 双协议栈（dual stack）
  - 同时支持 IPv4 和 IPv6 协议
- 隧道技术（tunneling）
  - IPv6 数据报进入 IPv4 网络时，把 IPv6 数据报封装成 IPv4 数据报

### ICMPv6

与 IPv4 一样，不保证可靠交付。新版的 ICMPv6，将 ARP（地址解析协议） 和 IGMP（网际组管理协议） 合并到了 ICMPv6 中。

## IP 多播

> TODO: 这块以后在细看（可能永远不看<\_<）

在互联网上进行多播就叫做`IP多播`.

IP 多播的目的地址，`D类IP地址`，即范围（D 类地址的千四位的前缀是 1110）为`224.0.0.0到239.255.255.255`

`多播路由器`，用于实现在互联网范围的多播，也可以转发普通的单播 IP 数据报。

IP 多播有两种：

- 本局域网上进行硬件多播
- 互联网范围进行多播

### IP 多播实现需要的协议

需要的协议：

- `网际组管理协议IGMP（Internet Group Manangement Protocol）`，让连接在`本地局域网`的多播路由器知道`本局域网`上是否有主机（严格讲，是主机上的进程）参加或退出多播组。
- `多播路由选择协议`
  - 洪泛和翦除
  - 隧道技术
  - 基于核心的发现技术

## 虚拟专用网 VPN 和网络地址转换 NAT

### 虚拟专用网 VPN

`专用地址`，只能用于一个机构内的通信，不能用于和互联网上的主机通信。即在互联网中的所有路由器，对`目的地址是专用地址`的数据报一律不进行转发。

专用网 IP 地址段

- A 类：10.0.0.0 到 10.255.255.255 （1658 万个）
- B 类：172.16.0.0 到 172.31.255.255 （104 万个）
- C 类：192.168.0.0 到 192.168.255.255 （6.5 万个）

互联网 IP（全球合法 IP） 地址段：

- A 类：
  - 1.0.0.0----9.255.255.255 （1.5 亿个）
  - 11.0.0.0-----126.255.255.255 （19.23 亿个）
- B 类：
  - 128.0.0.0-----172.15.255.255 （7.3 亿个）
  - 172.32.0.0-----191.255.255.255 （3.3 亿个）
- C 类：
  - 192.0.0.0-------192.167.255.255 （0.11 亿个）
  - 192.169.0.0-----223.255.255.255 （5.03 亿个）

VPN 的应用：

1. 专用网之间之间建立通信，特点：

- 与专用网连接的路由器具有`合法的全球IP`

2. 个人与专用网建立通信，特点：

- 员工通过拨号进入互联网
- 驻留在个人电脑中 VPN 软件，在个人电脑和公司主机之间建立 VPN 隧道

### 网络地址转换 NAT

解决的问题：专用网的主机，需要和互联网上的主机通信。

解决方案：在专用网连接到互联网的路由器上安装 NAT 软件，这种路由器称为`NAT路由器`，它至少有一个有效的外部全球 IP 地址。

`NAT路由器`的作用：

- NAT 路由器的通信，必须由`专用网发起`
- 将专用网中主机发送的 IP 数据报中的源 IP 地址，修改为 NAT 路由器的全球 IP 地址，然后转发出去。
- 将从互联网收到的 IP 数据报中的目标地址，通过 `NAT 地址转换表`，转化为专用网的目的主机的 IP 地址。

备注：当 NAT 转换表，仅记录 IP 时，同一时间，仅能有一台专用网的主机，使用 NAT 路由器向互联网通信。当 NAT 转换表，记录<ip, port>时，同一时间，支持多个专用网主机向互联网通信。

传统 NAT（traditional NAT），使用 IP 的转换表示例：

| 方向 | 字段         | 旧的 IP 地址 | 新的 IP 地址 |
| ---- | ------------ | ------------ | ------------ |
| 出   | 源 IP 地址   | 192.168.0.3  | 172.38.1.5   |
| 入   | 目的 IP 地址 | 172.38.1.5   | 192.168.0.3  |
| 出   | 源 IP 地址   | 192.168.0.7  | 172.38.1.6   |
| 入   | 目的 IP 地址 | 172.38.1.6   | 192.168.0.7  |

NAPT（Network Address And Port Translation）,使用 IP、端口的转换表示例：

| 方向 | 字段                      | 旧的 IP 地址和端口号 | 新的 IP 地址和端口号 |
| ---- | ------------------------- | -------------------- | -------------------- |
| 出   | 源 IP 地址:TCP 源端口     | 192.168.0.3:3000     | 172.38.1.5:40001     |
| 出   | 源 IP 地址:TCP 源端口     | 192.168.0.4:3000     | 172.38.1.5:40002     |
| 入   | 目的 IP 地址:TCP 目的端口 | 172.38.1.5:40001     | 172.38.0.3:3000      |
| 入   | 目的 IP 地址:TCP 目的端口 | 172.38.1.5:40002     | 172.38.0.4:3000      |

备注：路由器是工作在网络层的设备，NAPT 路由器，还要查看运输层的端口。

---
editLink: false
---

# 网络层

## 网络层的两种服务

- 虚电路服务。面向连接、可靠的服务。
- 数据报服务。无连接、最大努力交付的服务。

TCP/IP 体系中，网络层向上层（运输层）只提供简单灵活的、无连接的、尽最大努力交付的数据报（IP 数据报）服务。网络层不提供服务质量的承诺。

## 网际协议 IP（Internet Protocol）

这里的 IP 协议，指的是 TCP/IP 体系中的 IPv4 协议。

与 IP 协议配套的协议：

- 地址解析协议 ARP（Address Resolution Protocol）
- 网际报文控制协议 ICMP（Internet Control Message Protocol）
- 网际组管理协议 IGMP（Internet Group Management Protocol）

没有一种单一的网络能适应所有用户的需求（有各种各样的网络），将网络互相连接起来需要一些中间设备：

- 物理层，使用的中间设备为`转发器`
- 数据链路层，使用的中间设备为`网桥`或`桥接器`
- 网络层，使用的中间设备为`路由器`
- 网络层以上，使用的中间设备为`网关`

### IP 地址和硬件地址

`IP 地址`

- 即网络地址，主机在网络上的唯一标识。是网络层和以上各层是用的地址，是一种逻辑地址。
- 长度 32 位

`硬件地址（或物理地址、或MAC地址）`

- 是数据链路层和物理层是用的地址。
- 长度 48 位

> 局域网中，硬件地址已经固化在网卡的 ROM 中。

### 分类的 IP 地址

`分类的 IP 地址`将 IP 地址固定的划分为若干类，每一类由`网络号(net-id)`和`主机号(host-id)`组成，格式：

> IP 地址 ::= {<网络号>, <主机号>}

分类：

- A 类地址，{8, 24}，网络号的第一位为`0`
- B 类地址，{16, 16}，网络号的前两位为`10`，最小地址`128.1.0.0`
- C 类地址，{24, 8}，网络号的前三位为`110`，最小地址`192.0.1.0`
- D 类地址，前四位`1110`，用于多播（一对多通信）
- E 类地址，前四位`1111`，保留位以后用

两个特殊 IP 地址：

- `0.0.0.0`表示本网络。
- `127.0.0.1`保留作为本地软件`回环测试（lookback test）`本主机进程之间的通信之用。

路由器的特性：

- 路由器至少连接两个网络，至少具备两个不同的网络号。
- 路由器只根据目的站的 IP 地址的网络号进行路由转发。

### 地址解析协议 ARP

将`IP地址`解析为`硬件地址`.

每台主机都有一个`ARP高速换粗（ARP cache）`，里面有本局域网上各种主机和路由器的`IP地址`到`硬件地址`的映射，每条记录都有`生存时间`(如：10-20 分钟)

> linux 环境下，数据存储在/proc/net/arp，执行命令行 arp 也可查看数据

拼接 MAC 帧时，MAC 地址的查找规则：

- 找到 MAC 地址，直接写入
- 未找到 MAC 地址
  - ARP 进程在局域网网中，发送广播查找
    - 找到目的主机的 MAC 地址
    - 找到路由器的 MAC 地址

Question：既然链路层上传送的帧最终时按照`硬件地址`找到目标主机，为何要使用抽象的 IP 地址，不直接使用`硬件地址`进行通信？

1. 各种各样的网络，使用不同的硬件地址。
2. 异构的网络能够互相通信，必须进行`非常复杂硬件地址转换工作`，由用户、用户主机完成这个工作几乎是不可能的事情。
3. 主机拥有一个唯一的 IP 地址，他们之间的通信就像连接在同一个网络上那么简单。

### IP 数据报

格式：{{固定 20 个字节的首部}} {{可变长度的可选字段}} {{数据部分}}

备注：IP 数据报的最大长度为 2^16 -1 = 65535 个字节

### IP 层转发分组流程（路由器转发分组）

路由表中每条路由记录最主要的信息：<目的网络地址, 下一跳地址>

`路由表`中三种`路由记录`:

- `基于目的主机所在网络的交付`
  1. IP 数据报，最终一定能找到目的主机所在的目的网络上的路由器（可能要通过多次间接交付）。
  2. 只有到达最后一个路由器，才试图向目的主机进行直接交付。
- `特定主机路由`
- `默认路由`

```bash
# host ip为192.168.5.12的路由表

[root@localhost]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.5.1     0.0.0.0         UG    100    0        0 ens33
192.168.5.0     0.0.0.0         255.255.255.0   U     100    0        0 ens33
192.168.6.0     192.168.5.2     255.255.255.0   UG    0      0        0 ens33
```

路由表解释：

- 第一条记录为`默认路由`，下一跳地址为`192.168.5.1`
- 第二条记录为本网络的直接交付
- 第二条记录为，到`192.168.6.0`网络的下一跳地址为`192.168.5.2`
- Flags 中的
  - `U`表示`路由是可用的`
  - `G`表示下一跳为`路由器`；`G存在`为`间接交付`，`G不存在`为`直接交付`
  - `H`表示该路由是到一台`主机`，若`不设置H`，则表示该路由是一个`网络`

分组转发算法，路有优先级：

- 与路由器直连的网络，直接交付
- 路由表中特定主机路由，执行下一跳
- 路由表中的网络路由，执行下一跳
- 路由表中的默认路由，执行下一跳
- 报告分组转发失败

## 子网划分和构造超网

`两级 IP 地址` := { <网络号>, <主机号> }
`三级 IP 地址` := { <网络号>, <子网号>, <主机号> }

`子网的网络地址`：<IP 地址> AND <子网掩码>

## 网际控制报文协议 ICMP

## 互联网的路由选择协议

## IPV6

## IP 多播

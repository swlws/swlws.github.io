---
editLink: false
head:
  - - meta
    - name: author
      content: swlws
  - - meta
    - name: description
      content: 计算机网络-应用层
  - - meta
    - name: keywords
      content: dns ftp nfs telnet www email smtp pop3 imap dhcp system call p2p
---

[首先发布在微信公众号](https://mp.weixin.qq.com/s?__biz=Mzg2OTc0MzIxOA==&mid=2247483678&idx=1&sn=a0725d3e5d8a5ca4e968a1a6d05ca87f&chksm=ce992e03f9eea7150e2f8eccf2dd449be68b67ad7532795d91aafeeadc07f50b86e02425892b&token=2017381279&lang=zh_CN#rd)

---

# 应用层

每一种`应用层协议`，都是为了`解决某一类问题`，而问题的解决必须通过位于`不同主机`中的`多个应用进程`之间的通信和协同工作来完成。

应用层协议应当定义：

- 应用进程交换的`报文类型`，如请求报文和响应报文。
- 各种报文类型的语法，如报文中各个字段的含义及其详细描述。
- 字段的语意，即包含在字段中的信息的含义。
- 进程何时、如何发送报文，以及对报文进行响应的规则。

## 域名系统 DNS（Domain Name Systen）

DNS 的作用：将互联网上的主机名字转换为 IP 地址，域名到 IP 地址的解析，由分布在互联网上许多域名服务程序（即域名服务器）共同完成的。

> 互联网的域名系统 DNS 被设计为成为一个联机分布式数据库，并采用客户服务器方式。

### 互联网的域名结构

示例：mail.cctv.com ---> 三级域名.二级域名.顶级域名

顶级域名的分类：

- 国家顶级域名 nTLD。eg：
  - cn 中国
  - us 美国
  - uk 英国
- 通用顶级域名 gTLD。eg：
  - com 公司企业
  - net 网络服务机构
  - org 非营利性组织
  - int 国际组织
  - edu 教育机构
  - gov 政府部门
  - mil 军事部门
- 基础结构域名。仅有一个：
  - arpa 用于反向域名解析

### 域名服务器

域名服务器的四种类型：

- 根域名服务器（root name server）
  - 所有的`根域名服务器`，都知道所有的`顶级域名服务器`的`域名`和`IP`。
  - 所有的`根域名服务器`，共同使用 13 个 IP 地址。
  - 互联网中有 `13 套装置`，构成了 `13 组`根域名服务器。
- 顶级域名服务器（即 TLD 服务器）
  - 负责在管理在该`顶级域名服务器`注册的所有`二级域名`。
- 权限域名服务器
  - 一个服务器所负责管辖的（或有权限的）范围叫`区`。
  - 每一个区设置相应的`权限域名服务器`，用来保存该区中的所有主机的域名到 IP 地址的映射。
- 本地域名服务器（local name server）
  - 每一个互联网服务提供者 ISP，或一个大学，甚至大学的一个系，都可以拥有一个`本地域名服务器`。

域名的解析过程：

- `主机`向`本地域名服务器`的查询，一般采用`递归查询（recursive query）`。
- `本地域名服务器`向`根域名服务器`的查询，通常采用`迭代查询（iterative query）`。
  - 也可以采用`递归查询`，由请求报文的设置决定。

DNS 查询优化：

为了减轻根域名服务器的负荷和减少互联网上的 DNS 查询报文数量，域名服务器中广泛使用`高速缓存`(也称为`高速缓存域名服务器`)，存放最近查询过的域名以及从何处获得域名映射信息的记录。

```bash
# linux环境下，使用host命令解析域名的IP

> host baidu.com

baidu.com has address 220.181.38.148
baidu.com has address 220.181.38.251
```

## 文件传送协议

属于文件共享协议的有：

- 文件传送协议 FTP（File Transfer Protocol），基于 TCP 协议；简单文件传送协议 TFTP，基于 UDP 协议。
- 联机访问（on-line access）。
  - 允许`多个程序`同时对`同一个文件`进行存取。
  - 由`操作系统`提供对`远地共享文件`进行访问服务，就如同对本地文件的访问一样。
  - 操作系统对文件，提供`透明存取`，即将原来用于处理本地文件的应用程序用来处理本地文件时，不需要对程序做明显的改动。
- 网络文件系统 NFS（Network File System）
  - 可使本地计算机共享`远地的资源`，就像这些资源在本地一样。

### FTP 的基本工作原理

FTP 采用客户端/服务端模式，使用 TCP。

FTP 服务端的特点：

- 一个主进程，用与接受新的请求。
- 若干个从属进程，负责处理单个请求。
  - 控制进程
  - 数据传送进程

进行文件传输时，FTP 的客户端和服务端之间要建立两个并行的 TCP 连接：

- `控制连接`特点：
  - 整个会话期间，一直保持打开
  - 客户端发出的`传送请求`，通过`控制连接`发送给服务器端的`控制进程`
- `数据连接`特点：
  - 用于`传输文件`

### 简单文件传送协议 TFTP（Trivial File Transfer Protocol）

使用 UDP，只支持文件传送，不支持交互。优点：

- 可用于 UDP 环境
- TFTP 代码占用内存小

### 网络文件系统 NFS

NFS 允许应用进程打开一个进程文件，并能在该文件的某一特定的位置上开始读写数据。简单的说，就是像读写本地文件一样读写远地文件。

实战训练，[CentOS 7 中搭建 NFS 文件共享存储服务的完整步骤](https://cloud.tencent.com/developer/article/1721166)。

NFS 可能的使用场景：

- vscode 上有一款 ssh 插件，可以在本地编辑远程文件
- 云文件存储

> Question:
> rpcbind 服务的作用？

## 远程终端协议 TELNET

作用：

- 通过 TELNET 就可在其所在地通过 TCP 连接注册（登录）到远地的另一台主机上。
- 能将击键传到远地主机，同时也能远地主机的输出通过 TCP 连接返回到用户屏幕。

特点：

- 是一个简单的远程终端协议。
- 使用 TCP。
- 使用客户服务器方式。本地运行 TELNET 客户端进程，远地服务器运行 TELNET 服务器进程。
- 类似 FTP，服务器中的主进程等待新的请求，并产生从属进程来处理每一连接。
- 也被称为终端仿真协议。

**网络虚拟终端 NVT（Network Virtual Terminal）**

TELNET 能适应许多`计算机`和`操作系统`的`差异`，它定义了`数据和命令`应怎样通过`互联网`，这些定义就是所谓的`网络虚拟终端 NVT（Network Virtual Terminal）`

TELNET 工作流程：

1. 客户端把用户的击键、命令转化为`NVT格式`，并递交给服务端。
2. 服务端将收到的`NVT格式`，`转化`为远地服务器所需的格式。
3. 向用户返回数据时，`服务端`将`远地服务器的格式`转化为 `NVT 格式`，返回到客户端。
4. 客户端再将 `NVT 格式`，转化为`本地系统所需的格式`。

## 万维网 WWW（World Wide Web）

`万维网是一个大规模的、联机式的信息储存所，英文简称 Web`。

`万维网`以`客户服务器方式`工作，`客户程序`（eg：`浏览器`）向`服务端程序`（`万维网服务器`）发出请求，服务端程序向客户端程序送回客户所要的`万维网文档`。

**万维网需要解决的问题：**

1. 如何唯一标志分布在整个互联网上的每一个文档？`统一资源定位符URL（Uniform Resource Locator）`
2. 用什么协议实现万维网上的各种连接？`超文本传送协议HTTP（HyperText Transfer Protocol）`
3. 怎么展示不同风格的万维网文档？`超文本标记语言HTML（HyperText Markup Language）`

### 统一资源定位符 URL（Uniform Resource Locator）

URL 的一般格式：

> <协议>://<主机>:<端口>/<路径>

### 超文本传送协议 HTTP（HyperText Transfer Protocol）

HTTP 定义了浏览器（即万维网客户端进程）如何向万维网请求万维网文档，以及服务器怎样把文档传给浏览器。HTTP 协议是面向事物的应用层协议。

> 事务：指一系列的信息交换，而这一系列的信息交换是一个不可分割的整体。即要么所有信息交换都完成，要么一次交换都不进行。

HTTP 协议的特点：

- 使用了`面向连接`的 `TCP 协议`作为运输层协议，保证了数据的`可靠传输`。
- HTTP 协议不考虑在数据传输过程中，被丢弃后又怎么被传重。
- HTTP 协议本身是`无连接的`，即`通信的双方`在交换 HTTP 报文之前`不需要先建立 HTTP 连接`。
- HTTP 协议是`无状态的`。即同一客户，第二次访问同一个服务器上的页面时，服务器的相应与第一次相同。

#### 请求一个万维网文档

流程：

1. 使用三次握手建立连接。
2. 三次握手的`前两部分完成后`，客户端的请求报文，作为建立连接的三握手中的`第三个报文`，发送到万维网服务器。
3. 服务器收到 HTTP 请求报文后，将所请求的文档作为响应报文返回`客户端`。

耗时 = {两倍往返 RTT} + {文档传输时间}

> RTT(Round trip time)，以毫秒为单位的网络请求从起点到目的地并再次返回到起点所需的持续时间。

HTTP/1.0 缺点：

1. 每请求一个文档的`两倍 RTT 开销`。
2. 服务器每一次建立 TCP 连接都要`分配缓存和变量`。

HTTP/1.1 优点：采用`持续连接`。即万维网服务器在发送响应报文后，仍然在一段时间内保持这个连接。持续连接的有两种工作模式：

- 非流水线方式
  - 特点是，客户端收到前一个响应后，才能发送下一个请求。
  - 优点，节省建立 TCP 连接所需的一个 RTT 时间；缺点，服务器在发送完响应报文后，其 TCP 连接处于空闲状态。
- 流水线方式
  - 特点是，客户端收到 HTTP 响应报文之前，就能够接着发送新的请求报文，服务器可连续发回响应报文。

#### 代理服务器（proxy server）

代理服务器是一种`网络实体`，又被称为`万维网高速缓存`。代理服务器的作用：

1. 把最近的一些`请求`和`响应`暂存在`本地磁盘`
2. 当新请求到达时
   - 若请求内容与缓存匹配，则直接返回
   - 否则，`作为客户`去`互联网`获取资源，存储在代理服务器，再返回

#### HTTP 报文

HTTP 报文分为两类：

- 请求报文，从客户端向服务端发送请求报文。
- 响应报文，从服务端到客户的应答。

> HTTP 是面向文本的

`请求报文`的一些方法：

- OPTION。请求一些选项的信息
- HEAD。请求读取由 URL 所标志的信息
- TRACE。用于进行回环测试的请求报文
- CONNECT。用于代理服务器
- Get
- POST
- DELETE
- PUT

`响应报文`的状态码：

- 1xx 表示通知信息，如请求收到了活正在处理
- 2xx 表示成功，如接收或知道了
- 3xx 表示重定向，
- 4xx 表示客户的差错
- 5xx 表示服务器的差错

#### 在服务器上存放客户的信息

HTTP 是无状态的，可以使用 `Cookie` 识别、追踪用户。当网站使用 Cookie 时，工作流程：

1. 服务器为`用户A`产生一个唯一的识别码，并以此作为索引在服务器的后端数据库中产生一个项目。
2. 服务器给用户 A 的响应中添加一个为`Set-Cookie`的首部行。
3. 用户 A 收到带有`Set-Cookie`首部行的响应后，其浏览器就在它管理的特定 `Cookie文件`中添加一行，记录包含`服务器的主机名`和 `Set-Cookie 中的识别码`。
4. 之后，A 的所有 HTTP 请求，其浏览器都会从 Cookie 文件中读取这个网站的识别码，并放到 `HTTP 请求报文`的 `Cookie 首部`中。

### 万维网的文档

HTML 不是应用层的协议，是万维网浏览器使用的一种语言。

万维网的文档，分为两种：

- 静态文档
- 动态文档

要实现动态文档，需要对在`两个方面`对`万维网服务器的功能`进行`扩充`：

1. 应增加一个`应用程序`（`CGI程序`）
   1. 用来处理浏览器发来的数据
   2. 并动态创建文档。
2. 应增加一个`机制`（`通用网关接口CGI`）
   1. 用来使万维网服务器将浏览器发送的数据传送给这个应用程序
   2. 万维网服务器能理解这个应用服务器的数据，并向浏览器返回 HTML

`通用网关接口CGI(Common Gateway Interface)`，是一种标准，它定义了：

1. 动态文档应如何创建
2. `浏览器输入的数据`应如何提供给`应用程序`，
3. `应用程序的输出结果`应如何`应用`。

> 在看到 CGI 这个名词时，应弄清是指 CGI 标准，还是 CGI 程序。

`CGI 程序`的正式名称为 `CGI 脚本`，也被称为 `cgi-bin 脚本`。

### 万维网的信息检索系统

搜索引擎的分类：

- 全文检索搜索引擎
  - [必应](cn.bing.com)
  - [百度](www.baidu.com)
  - [谷歌](www.google.com)
- 目录检索搜索引起
  - [雅虎](www.yahoo.com)
  - [雅虎中国](cn.yahoo.com)
  - [新浪](sina.com.cn)
  - [搜狐](www.sohu.com)
  - [网易](www.163.com)
- 垂直搜索引擎（Vertical Search Engine）。针对`某一特定领域`、`特定人群`或`某一特定需求`提供搜索服务。
- 元搜索引擎（Meta Search Engine）。将用户提交的搜索请求发送到`多个独立的搜索引擎`上去搜索，然后`整合检索结果`，按`统一格式展示`。

## 电子邮件（e-mail）

电子邮件的两个重要标准：

- 简单邮件传送协议 SMTP（Simple Mail Transfer Protocol）
- 互联网文本报文格式

电子邮件三个组成构件：

- 用户代理
- 邮件服务器
- 邮件发送协议（如 SMTP）和邮件读取协议（如 POP3）

> POP3 指邮局协议（Post Office Protocol）的版本 3

`用户代理UA（User Agent）`，也称为`电子邮件客户端软件`，就是用户与电子邮件系统的接口，大多数情况下就是运行在用户电脑中的一个程序，如 `Outlook`、`Foxmail`.

**邮件服务器：**

1. 按照`客户服务器`方式工作，SMTP 服务器使用的 TCP 端口为 25。
2. 使用两种不同的协议
   1. 一种用于`用户代理`向`邮件服务器`发送邮件或在`邮件服务器之间`发送邮件，如 SMTP
   2. 一种用于`用户代理`从`邮件服务器`读取邮件，如邮局协议 POP3
3. 能够同时充当客户和服务器

### 邮件读取协议 POP3 和 IMAP

邮局协议 POP3 （Post Office Protocol）的特点：

- `客户服务器`的工作方式
- 用户从 POP3 服务器`读取邮件后`，POP3 就`把该邮件删除`

网际报文存取协议 IMAP（Internet Message Access Protocol）特点：

- `客户服务器`的工作方式
- 是一个`联机协议`。用户可以在自己的机器上操作邮件服务器的邮箱，就像在本地操作一样。
- 可以在`不同的地方`、`不同的机器`，随时上网阅读和处理邮件

`基于万维网的电子邮件`，直接使用浏览器操作电子邮件。

## 动态主机配置协议 DHCP

DHCP 提供一种机制，称为`即插即用连网（plug-and-play networking）`，这种机制允许一台计算`加入新的网络`和`获取新的 IP 地址`不用手工配置。

一台主机获取 IP 的流程：

- 方式一：本网络广播，DHCP 服务器 返回 IP 地址
- 方式二：本网络广播，DHCP 中继代理向 DHCP 服务器单播，DHCP 服务器 返回 IP 地址

DHCP 获取的 IP 地址，是`有时效期`的，这段时间称为`租用期（lease period）`，这个时长有 DHCP 服务器自己决定。

## 应用进程跨越网络的通信

大多数操作系统使用`系统调用(system call)`的机制，在`应用程序`和`操作系统`之间传递控制权。

`系统调用接口`，也称为`应用编程接口 API（Application Programming Interface）`，实际上是`应用进程的控制权`与`操作系统的控制权`进行`转换`的一个接口。

几种常用的系统调用：

- 连接建立阶段
  - `bind（绑定）`。指明套接字的本地地址（本地端口号和本地 IP 地址）。
  - `listen（收听）`。把套接字设置为被动方式，以便随时接收客户的请求。
  - `access（接受）`。把远地客户进程发送的连接请求提取出来。
  - `connect`。客户端进程使用 connect 和远地服务器建立连接。
- 数据传输阶段
  - `send`。客户端、服务端都可以使用 send 发送数据
  - `recv`。客户端、服务端都可以使用 send 接收数据
- 连接释放阶段
  - `close`。释放连接和撤销套接字

## P2P 应用

`P2P 应用`指具有 P2P 体系结构的`网络应用`，没有（或只有极少数的）固定的服务器，绝大多数的交互都是使用`对等方式（P2P 方式）进行`。

**实现方式：**

- `具有集中目录服务器的 P2P 工作方式`
  - 第一代 P2P 应用：Napster 网站
    - 特点：
      - `集中式的目录查询服务器`
- `具有全分布式结构的 P2P 文件共享程序`
  - 第二代 P2P 应用：Gnutella 网站
    - 特点：
      - 不采用集中式的目录查询服务器，采用`有限范围的洪泛法`。
  - 第三代 P2P 应用：KaZaA、电骡 eMule、比特洪流 BT（Bit Torrent）
    - 特点：
      - 使用分散定位、分散传输技术

`分布式散列表 DHT（Distributed Hash Table）`，也称作`分布式哈希表`，它是由`大量对等方`共同维护的。基于 DHT 的算法：

- Chord
- Pastry
- CAN(Content Address Network)
- Kademilia

## SSH

安全登录，采用客户服务器的工作方式。

---

<div style="text-align:center;">

<img src="/imgs/wechat_article.jpg"/><br/>
<span>微信公众号</span>

</div>
